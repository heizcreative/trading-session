<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Killzone Monitor</title>

<style>
  :root{
    --notion-dark: #0f0f10;
    --card: rgba(255,255,255,.06);
    --stroke: rgba(255,255,255,.10);

    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.60);

    --open: #28E6A5;
    --closed: #FF4D6D;

    --radius: 16px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }

  *{ box-sizing:border-box; }

  html, body{
    margin:0;
    padding:0;
    height:100%;
    background: var(--notion-dark) !important;
  }

  body{
    color: var(--text);
    font-family: var(--sans);
    padding: 12px;
  }

  .wrap{
    width: min(980px, 100%);
    margin: 0 auto;
  }

  .panel{
    background: var(--notion-dark);
    border-radius: var(--radius);
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.08);
  }

  .header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    padding: 12px 12px 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,.07);
  }

  .title h1{
    margin:0;
    font-size: 14px;
    font-weight: 800;
    letter-spacing:.2px;
  }
  .title p{
    margin:4px 0 0 0;
    font-size: 12px;
    color: var(--muted);
  }

  .chip{
    font-family: var(--mono);
    font-size: 12px;
    color: rgba(255,255,255,.85);
    padding: 7px 10px;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.28);
    white-space:nowrap;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 10px;
    padding: 12px;
  }
  @media (max-width: 760px){
    .grid{ grid-template-columns: 1fr; }
  }

  .card{
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    padding: 12px;
    background: var(--card);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }

  .left{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }

  .dot{
    width:10px; height:10px;
    border-radius:50%;
    background: var(--closed);
    box-shadow: 0 0 0 4px rgba(255,77,109,.14);
    flex:0 0 auto;
  }

  .names{
    display:flex;
    flex-direction:column;
    gap:2px;
    min-width:0;
  }
  .names b{
    font-size:13px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .names span{
    font-size:11px;
    color: var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .status{
    font-family: var(--mono);
    font-size: 11px;
    padding: 6px 10px;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.25);
    white-space:nowrap;
  }

  .mid{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap: 10px;
    margin-top: 12px;
  }

  .clock{
    font-family: var(--mono);
    font-size: 26px;
    letter-spacing:.4px;
    line-height:1;
  }

  /* One stable line (no blinking). We only update once per minute. */
  .timerline{
    text-align:right;
    font-size: 11px;
    color: var(--muted);
    line-height:1.35;
  }
  .timerline .big{
    margin-top: 2px;
    font-family: var(--mono);
    color: rgba(255,255,255,.88);
    font-size: 12px;
    display:inline-block;
    min-width: 110px; /* prevents layout shift */
    text-align:right;
  }

  .open .dot{
    background: var(--open);
    box-shadow: 0 0 0 4px rgba(40,230,165,.14);
  }
  .open .status{
    color: rgba(40,230,165,.95);
    border-color: rgba(40,230,165,.22);
    background: rgba(40,230,165,.10);
  }
  .closed .status{
    color: rgba(255,77,109,.95);
    border-color: rgba(255,77,109,.22);
    background: rgba(255,77,109,.08);
  }

  .footer{
    padding: 10px 12px 12px 12px;
    border-top: 1px solid rgba(255,255,255,.07);
    color: var(--muted);
    font-size: 11px;
    display:flex;
    justify-content:space-between;
    gap:10px;
  }

  .pill{
    font-family: var(--mono);
    padding: 2px 8px;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.22);
    color: rgba(255,255,255,.75);
    display:inline-block;
    white-space:nowrap;
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <div class="header">
      <div class="title">
        <h1>Killzone Monitor</h1>
        <p>Asia Range · London Killzone · NY Killzone (ET)</p>
      </div>
      <div class="chip" id="etNow">ET --:--</div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="footer">
      <div>Status uses <span class="pill">ET</span></div>
      <div id="nextGlobal">Next: <span class="pill">--</span></div>
    </div>
  </div>
</div>

<script>
  const USER_TZ = "America/Toronto";

  const WINDOWS = [
    { key:"asia",   name:"Asia Range",      start:"20:00", end:"00:00" },
    { key:"london", name:"London Killzone", start:"02:00", end:"05:00" },
    { key:"ny",     name:"NY Killzone",     start:"09:30", end:"11:00" }
  ];

  const grid = document.getElementById("grid");
  const pad = n => String(n).padStart(2,"0");

  function parseHM(hm){
    const [h,m] = hm.split(":").map(Number);
    return h*60 + m;
  }

  function hhmmInTZ(tz, d=new Date()){
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: tz, hour12:false, hour:"2-digit", minute:"2-digit"
    }).format(d);
  }

  function minsInTZ(tz, d=new Date()){
    const t = hhmmInTZ(tz, d);
    const [HH,MM] = t.split(":").map(Number);
    return HH*60 + MM;
  }

  function etClockShort(){
    const t = hhmmInTZ(USER_TZ);
    return `ET ${t}`;
  }

  function formatHMM(ms){
    const totalMin = Math.max(0, Math.ceil(ms/60000));
    const h = Math.floor(totalMin/60);
    const m = totalMin%60;
    if(h <= 0) return `${m}m`;
    return `${h}h ${m}m`;
  }

  function isOpen(win){
    const nowM = minsInTZ(USER_TZ);
    const startM = parseHM(win.start);
    const endM = parseHM(win.end);

    if(endM > startM) return (nowM >= startM && nowM < endM);
    return (nowM >= startM || nowM < endM);
  }

  function nextOccurrence(minuteOfDay){
    const now = new Date();
    for(let i=0; i<=48*60; i++){
      const probe = new Date(now.getTime() + i*60*1000);
      if(minsInTZ(USER_TZ, probe) === minuteOfDay) return probe.getTime();
    }
    return null;
  }

  function nextEvent(win){
    const startM = parseHM(win.start);
    const endM   = parseHM(win.end);

    const nextOpen  = nextOccurrence(startM);
    const nextClose = nextOccurrence(endM);

    const openNow = isOpen(win);
    const when = openNow ? nextClose : nextOpen;
    const type = openNow ? "closes" : "opens";

    return { openNow, when, type };
  }

  function build(){
    grid.innerHTML = "";
    for(const w of WINDOWS){
      const el = document.createElement("div");
      el.className = "card closed";
      el.id = `card-${w.key}`;
      el.innerHTML = `
        <div class="top">
          <div class="left">
            <div class="dot"></div>
            <div class="names">
              <b>${w.name}</b>
              <span>${w.start}–${w.end} (ET)</span>
            </div>
          </div>
          <div class="status" id="status-${w.key}">CLOSED</div>
        </div>

        <div class="mid">
          <div class="clock" id="clock-${w.key}">--:--</div>
          <div class="timerline">
            <div id="label-${w.key}">--</div>
            <div class="big" id="timeleft-${w.key}">--</div>
          </div>
        </div>
      `;
      grid.appendChild(el);
    }
  }

  // Updates OPEN/CLOSED + time remaining (once per minute)
  function updateSessions(){
    let global = null;

    for(const w of WINDOWS){
      const ev = nextEvent(w);
      const card = document.getElementById(`card-${w.key}`);
      card.classList.toggle("open", ev.openNow);
      card.classList.toggle("closed", !ev.openNow);

      document.getElementById(`status-${w.key}`).textContent = ev.openNow ? "OPEN" : "CLOSED";

      const labelEl = document.getElementById(`label-${w.key}`);
      const leftEl  = document.getElementById(`timeleft-${w.key}`);

      if(ev.when){
        const ms = ev.when - Date.now();
        labelEl.textContent = ev.openNow ? "Closes in" : "Opens in";
        leftEl.textContent = formatHMM(ms);

        if(!global || ev.when < global.when){
          global = { when: ev.when, text: `${w.name} ${ev.type}` };
        }
      }else{
        labelEl.textContent = "--";
        leftEl.textContent = "--";
      }
    }

    if(global){
      document.getElementById("nextGlobal").innerHTML =
        `Next: <span class="pill">${global.text}</span> <span class="pill">${formatHMM(global.when - Date.now())}</span>`;
    }
  }

  // Updates ONLY the display clocks (no countdown) - smooth & not distracting
  function updateClocks(){
    document.getElementById("etNow").textContent = etClockShort();
    const t = hhmmInTZ(USER_TZ);
    for(const w of WINDOWS){
      document.getElementById(`clock-${w.key}`).textContent = t;
    }
  }

  build();
  updateClocks();
  updateSessions();

  // clocks refresh every 10 seconds (smooth, not flashy)
  setInterval(updateClocks, 10000);

  // session timers refresh once per minute (NO BLINK)
  setInterval(updateSessions, 60000);
</script>
</body>
</html>
